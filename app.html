<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>èŠå¤©å®¤</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    margin: 0;
    font-family: 'Microsoft JhengHei', sans-serif;
    height: 100vh;
    display: flex;
  }
  
  /* æœ€å·¦å´ä¸»é¸å–® */
  #main-sidebar {
    width: 5%;
    background: #202225;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 0;
    gap: 15px;
  }
  
  .main-menu-item {
    width: 40px;
    height: 40px;
    background: #36393f;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    color: #dcddde;
    transition: all 0.3s ease;
    position: relative;
  }
  
  .main-menu-item:hover, .main-menu-item.active {
    background: #5865f2;
    border-radius: 16px;
    transform: scale(1.1);
  }
  
  .main-menu-item.avatar {
    background-size: cover;
    background-position: center;
    background-image: url('https://i.imgur.com/4Z7hFfK.png');
    margin-top: auto;
    margin-bottom: 10px;
  }

  /* ä¸­é–“é¸å–®æ¬„ */
  #middle-sidebar {
    width: 15%;
    background: #2f3136;
    color: white;
    display: flex;
    flex-direction: column;
  }
  
  .middle-header {
    padding: 15px;
    background: #36393f;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    position: relative;
  }
  
  .middle-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px 0;
  }
  
  /* å¥½å‹åˆ—è¡¨æ¨£å¼ */
  .friends-page .friend {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #3a3b3f;
    display: flex;
    align-items: center;
  }
  
  .friends-page .friend:hover {
    background: #40444b;
  }
  
  .friends-page .active-friend {
    background: #5865f2;
  }
  
  /* ç¾¤çµ„åˆ—è¡¨æ¨£å¼ */
  .group-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #3a3b3f;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  
  .group-item:hover {
    background: #40444b;
  }
  
  .group-item.active {
    background: #5865f2;
  }
  
  .group-name {
    flex: 1;
    font-weight: 500;
  }
  
  .group-info {
    font-size: 12px;
    color: #b3b3b3;
    margin-top: 2px;
  }
  
  .group-options {
    opacity: 0;
    transition: opacity 0.2s;
  }
  
  .group-item:hover .group-options {
    opacity: 1;
  }
  
  .group-options button {
    background: none;
    border: none;
    color: #dcddde;
    cursor: pointer;
    font-size: 14px;
    padding: 4px 6px;
    border-radius: 3px;
    margin-left: 4px;
  }
  
  .group-options button:hover {
    background: #5865f2;
  }
  
  /* è¨­å®šé é¢æ¨£å¼ */
  .settings-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #3a3b3f;
  }
  
  .settings-item:hover {
    background: #40444b;
  }
  
  /* é é¢éš±è— */
  .page {
    display: none;
  }
  
  .page.active {
    display: flex;
    flex-direction: column;
  }

  /* èŠå¤©å€ */
  #chat-container {
    width: 80%;
    display: flex;
    flex-direction: column;
    background: #f4f4f4;
  }
  header {
    background: #667eea;
    color: white;
    padding: 15px;
    font-size: 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chat-header-info {
    display: flex;
    flex-direction: column;
  }
  
  .chat-header-title {
    font-size: 18px;
    font-weight: bold;
  }
  
  .chat-header-subtitle {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 2px;
  }
  
  .chat-header-actions {
    display: flex;
    gap: 10px;
  }
  
  .header-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  
  .header-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  #messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
  }
  .message-wrapper {
    display: flex;
    align-items: flex-start;
    margin: 5px 0;
    position: relative;
    padding-right: 30px;
  }
  .message {
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 70%;
    word-wrap: break-word;
    animation: fadeIn 0.3s;
  }
  .self {
    background: #abbaff;
    color: rgb(0, 0, 0);
    margin-left: auto;
  }
  .other {
    background: #e8e8e8;
    color: black;
    margin-right: auto;
  }
  .reply-reference {
    font-size: 12px;
    color: #666;
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 8px;
    border-radius: 4px;
    margin-bottom: 4px;
    cursor: pointer;
    border-left: 3px solid #333;
  }
  .message.self .reply-reference {
    background: rgba(255, 255, 255, 0.3);
    color: #ddd;
    border-left-color: #ddd;
  }
  .reactions {
    font-size: 12px;
    margin-top: 4px;
  }
  .reaction {
    display: inline-block;
    margin-right: 5px;
    padding: 2px 6px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    cursor: pointer;
  }
  #input-area {
    display: flex;
    border-top: 1px solid #ccc;
    padding: 10px;
    background: white;
    gap: 5px;
  }
  #messageInput {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  #sendBtn, #fileBtn {
    padding: 8px 16px;
    background: #48bb78;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #sendBtn:hover, #fileBtn:hover {
    background: #38a169;
  }
  #fileInput {
    display: none;
  }
  img.chat-image {
    max-width: 200px;
    border-radius: 8px;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Modal æ¨£å¼ */
  .modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  
  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    text-align: center;
  }
  
  .modal-content h3 {
    margin-top: 0;
    color: #333;
  }
  
  .modal-content input {
    width: 90%;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  
  .modal-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
  }
  
  .modal-buttons button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .btn-primary {
    background: #5865f2;
    color: white;
  }
  
  .btn-secondary {
    background: #ccc;
    color: black;
  }
  
  .btn-danger {
    background: #e53e3e;
    color: white;
  }
  
  /* å¥½å‹é¸æ“‡åˆ—è¡¨ */
  .friend-select-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin: 10px 0;
  }
  
  .friend-select-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  
  .friend-select-item:hover {
    background: #f0f0f0;
  }
  
  .friend-select-item input[type="checkbox"] {
    margin-right: 10px;
  }
  
  .friend-select-item:last-child {
    border-bottom: none;
  }
  
  /* ç¾¤çµ„æˆå“¡åˆ—è¡¨ */
  .member-list {
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
  }
  
  .member-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
  }
  
  .member-item:last-child {
    border-bottom: none;
  }
  
  .member-info {
    display: flex;
    align-items: center;
    flex: 1;
  }
  
  .member-name {
    font-weight: 500;
    margin-right: 8px;
  }
  
  .member-role {
    font-size: 12px;
    color: #666;
    background: #f0f0f0;
    padding: 2px 6px;
    border-radius: 10px;
  }
  
  .member-actions {
    display: flex;
    gap: 5px;
  }
  
  .member-actions button {
    padding: 4px 8px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
  }
  
  .msg-error {
    color: red;
    font-size: 14px;
    margin-top: 10px;
  }
  
  .msg-success {
    color: green;
    font-size: 14px;
    margin-top: 10px;
  }
  
  /* ä¸‰é»é¸å–® */
  .more-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: gray;
    visibility: hidden;
    position: absolute;
    right: 5px;
    top: 5px;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .message-wrapper:hover .more-btn {
    visibility: visible;
  }

  .action-menu {
    position: fixed;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 100;
    min-width: 120px;
  }
  
  .action-menu div {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
  }
  
  .action-menu div:last-child {
    border-bottom: none;
  }
  
  .action-menu div:hover {
    background: #f0f0f0;
  }

  /* å›è¦†è¨Šæ¯å€å¡Šæ¨£å¼ */
  #replyBox {
    display: none;
    background: #f0f0f0;
    padding: 8px 12px;
    font-size: 13px;
    border-top: 1px solid #ccc;
    color: #333;
    position: relative;
  }
  
  #replyBox .reply-info {
    font-weight: bold;
    color: #667eea;
  }
  
  #replyCancel {
    position: absolute;
    right: 12px;
    top: 8px;
    cursor: pointer;
    font-weight: normal;
    color: #666;
    background: #ddd;
    border: none;
    border-radius: 3px;
    padding: 2px 6px;
    font-size: 12px;
  }
  
  #replyCancel:hover {
    background: #ccc;
  }

  /* é ­åƒé¸å–®å½ˆçª— */
  #avatar-menu {
    position: fixed;
    bottom: 60px;
    left: 10px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    min-width: 150px;
  }
  
  .avatar-menu-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
  }
  
  .avatar-menu-item:last-child {
    border-bottom: none;
    color: #e53e3e;
  }
  
  .avatar-menu-item:hover {
    background: #f0f0f0;
  }
  
  /* ç©ºç‹€æ…‹æ¨£å¼ */
  .empty-state {
    padding: 40px 20px;
    text-align: center;
    color: #888;
  }
  
  .empty-state h3 {
    margin-bottom: 10px;
    color: #666;
  }
  
  .empty-state p {
    margin-bottom: 20px;
    line-height: 1.5;
  }

  /* èª¿è©¦ä¿¡æ¯æ¨£å¼ */
  .debug-info {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
    margin: 10px 0;
    font-family: monospace;
    font-size: 12px;
    color: #495057;
  }

  .debug-error {
    background: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }
  .debug-info { display: none !important; }

</style>
<style>
  /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
@media (max-width: 768px) {
  body {
    flex-direction: column !important;
    height: auto !important;
  }

  /* ä¸»é¸å–®è®Šæˆåº•éƒ¨å·¥å…·åˆ— */
  #main-sidebar {
    flex-direction: row !important;
    justify-content: space-around;
    width: 100%;
    height: 60px;
    position: fixed;
    bottom: 0;
    left: 0;
    background: #202225;
    padding: 0;
    gap: 0;
    z-index: 100;
  }

  .main-menu-item {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    font-size: 20px;
  }

  /* éš±è—ä¸­é–“æ¬„ */
  #middle-sidebar {
    display: none !important;
  }

  /* èŠå¤©å€å…¨å¯¬ï¼Œä¸¦é ç•™åº•éƒ¨ç©ºé–“ */
  #chat-container {
    width: 100% !important;
    margin-bottom: 60px;
  }

  /* è¼¸å…¥å€åŸŸé©åˆè§¸æ§ */
  #input-area {
    padding: 8px;
    gap: 8px;
  }
  #messageInput {
    font-size: 16px;
    padding: 10px;
  }
  #sendBtn, #fileBtn {
    padding: 10px 14px;
    font-size: 16px;
  }

  /* Modal å…¨è¢å¹•é¡¯ç¤º */
  .modal-content {
    width: 90% !important;
    max-height: 90vh;
  }
}
@media (max-width: 768px) {
  /* ä¸»é¸å–®è®Šåº•éƒ¨å·¥å…·åˆ— */
  #main-sidebar {
    flex-direction: row !important;
    justify-content: space-around !important;
    align-items: center !important; /* å‚ç›´ç½®ä¸­ */
    width: 100% !important;
    height: 60px !important;
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    background: #202225 !important; /* æ·±è‰²èƒŒæ™¯ */
    padding: 0 !important;
    gap: 0 !important;
    z-index: 1000 !important;
  }

  /* æŒ‰éˆ•å¤§å°èˆ‡æ¨£å¼ */
  .main-menu-item {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 50px !important;
    height: 50px !important;
    border-radius: 12px !important;
    font-size: 20px !important;
    color: white !important;
    background: #2f3136 !important;
  }

  /* ä¸­é–“æ¬„å…ˆéš±è— */
  #middle-sidebar {
    display: none !important;
  }

  /* èŠå¤©å€å…¨å¯¬ */
  #chat-container {
    width: 100% !important;
    margin-bottom: 60px !important; /* é ç•™åº•éƒ¨ç©ºé–“ */
  }
}
.message .meta-info {
  font-size: 10px;
  color: #888;
  margin-top: 2px;
  white-space: pre-line;
}

.message.self .meta-info {
  color: #ddd;
}
@media (max-width: 768px) {
  /* ä¸­é—´æ é»˜è®¤éšè—ï¼Œä½†åœ¨æŸäº›é¡µé¢éœ€è¦æ˜¾ç¤º */
  #middle-sidebar {
    display: none !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100vh !important;
    z-index: 999 !important;
    background: #2f3136 !important;
  }
  
  /* å½“æ˜¾ç¤ºä¸­é—´æ æ—¶ */
  #middle-sidebar.mobile-show {
    display: flex !important;
  }
  
  /* èŠå¤©åŒºåœ¨æ˜¾ç¤ºä¸­é—´æ æ—¶éšè— */
  #chat-container.mobile-hide {
    display: none !important;
  }
}
</style>
</head>
<body>

<!-- æœ€å·¦å´ä¸»é¸å–® -->
<div id="main-sidebar">
  <div class="main-menu-item" data-page="messages" title="è¨Šæ¯">ğŸ’¬</div>
  <div class="main-menu-item" data-page="home" title="ä¸»é ">ğŸ </div>
  <div class="main-menu-item" data-page="friends" title="å¥½å‹">ğŸ‘¥</div>
  <div class="main-menu-item" data-page="groups" title="ç¾¤çµ„">ğŸ‘ª</div>
  <div class="main-menu-item" data-page="communities" title="ç¤¾ç¾¤">ğŸŒ</div>
  <div class="main-menu-item" data-page="settings" title="è¨­å®š">âš™ï¸</div>
  <div class="main-menu-item avatar" id="avatar-btn" title="å€‹äººè³‡æ–™"></div>
</div>

<!-- ä¸­é–“é¸å–®æ¬„ -->
<div id="middle-sidebar">
  <!-- è¨Šæ¯é é¢ -->
  <div class="page" id="messages-page">
    <div class="middle-header">è¨Šæ¯</div>
    <div class="middle-content">
      <div id="messagesFriendsList"></div>
      <div style="padding: 15px; text-align: center;">
        <button id="addFriendBtnMessages" class="btn-primary" style="border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">åŠ å¥½å‹</button>
      </div>
    </div>
  </div>
  
  <!-- ä¸»é  -->
  <div class="page" id="home-page">
    <div class="middle-header">ä¸»é </div>
    <div class="middle-content">
      <div style="padding: 15px;">
        <h3>æ­¡è¿ä¾†åˆ° FayCRChat!</h3>
        <p>é–‹å§‹å’Œæœ‹å‹èŠå¤©å§ï¼</p>
      </div>
    </div>
  </div>
  
  <!-- å¥½å‹é é¢ -->
  <div class="page friends-page" id="friends-page">
    <div class="middle-header">å¥½å‹åˆ—è¡¨</div>
    <div class="middle-content">
      <div id="friendsList"></div>
      <div style="padding: 15px; text-align: center;">
        <button id="addFriendBtn" class="btn-primary" style="border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">åŠ å¥½å‹</button>
      </div>
    </div>
  </div>
  
  <!-- ç¾¤çµ„é é¢ -->
  <div class="page" id="groups-page">
    <div class="middle-header">
      ç¾¤çµ„
      <button id="createGroupBtn" style="float:right; background: #5865f2; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
        â• å»ºç«‹
      </button>
    </div>
    <div class="middle-content">
      <div class="debug-info" id="debugInfo">
        <div>ç”¨æˆ¶ UID: <span id="debugUid">è¼‰å…¥ä¸­...</span></div>
        <div>Firebase ç‹€æ…‹: <span id="debugFirebase">åˆå§‹åŒ–ä¸­...</span></div>
        <div>ç¾¤çµ„ç›£è½ç‹€æ…‹: <span id="debugGroups">æœªé–‹å§‹...</span></div>
      </div>
      <div id="groupsList">
        <div class="empty-state">
          <h3>ğŸ  è¼‰å…¥ç¾¤çµ„ä¸­...</h3>
          <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ç¾¤çµ„åˆ—è¡¨ï¼Œè«‹ç¨å€™...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ç¤¾ç¾¤é é¢ -->
  <div class="page" id="communities-page">
    <div class="middle-header">ç¤¾ç¾¤</div>
    <div class="middle-content">
      <div class="empty-state">
        <h3>ğŸŒ ç¤¾ç¾¤åŠŸèƒ½</h3>
        <p>æ•¬è«‹æœŸå¾…...</p>
      </div>
    </div>
  </div>
  
  <!-- è¨­å®šé é¢ -->
  <div class="page" id="settings-page">
    <div class="middle-header">è¨­å®š</div>
    <div class="middle-content">
      <div class="settings-item">å€‹äººè³‡æ–™</div>
      <div class="settings-item">éš±ç§è¨­å®š</div>
      <div class="settings-item">é€šçŸ¥è¨­å®š</div>
      <div class="settings-item">ä¸»é¡Œè¨­å®š</div>
      <div class="settings-item">èªè¨€è¨­å®š</div>
      <div class="settings-item">é—œæ–¼</div>
    </div>
  </div>
</div>

<!-- èŠå¤©å€ -->
<div id="chat-container">
  <header id="chatHeader">
    <div class="chat-header-info">
      <div class="chat-header-title">è«‹é¸æ“‡ç¾¤çµ„</div>
      <div class="chat-header-subtitle" id="chatHeaderSubtitle"></div>
    </div>
    <div class="chat-header-actions" id="chatHeaderActions" style="display: none;">
      <button class="header-btn" id="inviteMembersBtn">é‚€è«‹æˆå“¡</button>
      <button class="header-btn" id="groupSettingsBtn">ç¾¤çµ„è¨­å®š</button>
    </div>
  </header>
  
  <div id="messages">
    <div class="empty-state">
      <h3>ğŸ’¬ é–‹å§‹ç¾¤çµ„èŠå¤©</h3>
      <p>é¸æ“‡ä¸€å€‹ç¾¤çµ„é–‹å§‹èŠå¤©ï¼Œæˆ–å»ºç«‹æ–°ç¾¤çµ„é‚€è«‹æœ‹å‹åŠ å…¥ï¼</p>
    </div>
  </div>
  
  <!-- å›è¦†è¨Šæ¯å€å¡Š -->
  <div id="replyBox">
    <div class="reply-info">å›è¦† <span id="replyUser"></span>:</div>
    <div id="replyText"></div>
    <button id="replyCancel">âœ–</button>
  </div>

  <div id="input-area">
    <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." disabled />
    <button id="fileBtn" disabled>ğŸ“</button>
    <input type="file" id="fileInput" />
    <button id="sendBtn" disabled>é€å‡º</button>
  </div>
</div>

<!-- å»ºç«‹ç¾¤çµ„å½ˆçª— -->
<div id="createGroupModal" class="modal">
  <div class="modal-content">
    <h3>å»ºç«‹æ–°ç¾¤çµ„</h3>
    <input type="text" id="groupNameInput" placeholder="ç¾¤çµ„åç¨±" />
    <input type="text" id="groupDescInput" placeholder="ç¾¤çµ„æè¿° (é¸å¡«)" />
    <div class="modal-buttons">
      <button id="confirmCreateGroup" class="btn-primary">å»ºç«‹</button>
      <button id="cancelCreateGroup" class="btn-secondary">å–æ¶ˆ</button>
    </div>
    <p id="createGroupMsg" class="msg-error"></p>
  </div>
</div>

<!-- é‚€è«‹æˆå“¡å½ˆçª— -->
<div id="inviteMembersModal" class="modal">
  <div class="modal-content">
    <h3>é‚€è«‹å¥½å‹åŠ å…¥ç¾¤çµ„</h3>
    <div class="friend-select-list" id="friendSelectList">
      <div style="text-align: center; color: #888; padding: 20px;">è¼‰å…¥ä¸­...</div>
    </div>
    <div class="modal-buttons">
      <button id="confirmInviteMembers" class="btn-primary">ç™¼é€é‚€è«‹</button>
      <button id="cancelInviteMembers" class="btn-secondary">å–æ¶ˆ</button>
    </div>
    <p id="inviteMembersMsg" class="msg-error"></p>
  </div>
</div>

<!-- ç¾¤çµ„è¨­å®šå½ˆçª— -->
<div id="groupSettingsModal" class="modal">
  <div class="modal-content">
    <h3>ç¾¤çµ„è¨­å®š</h3>
    <div style="text-align: left;">
      <h4>ç¾¤çµ„è³‡è¨Š</h4>
      <input type="text" id="editGroupName" placeholder="ç¾¤çµ„åç¨±" />
      <input type="text" id="editGroupDesc" placeholder="ç¾¤çµ„æè¿°" />
      
      <h4>ç¾¤çµ„æˆå“¡ (<span id="memberCount">0</span>)</h4>
      <div class="member-list" id="memberList">
        <div style="text-align: center; color: #888; padding: 20px;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    <div class="modal-buttons">
      <button id="saveGroupSettings" class="btn-primary">å„²å­˜è¨­å®š</button>
      <button id="cancelGroupSettings" class="btn-secondary">å–æ¶ˆ</button>
      <button id="leaveGroup" class="btn-danger">é›¢é–‹ç¾¤çµ„</button>
    </div>
    <p id="groupSettingsMsg" class="msg-error"></p>
  </div>
</div>

<!-- åŠ å¥½å‹å½ˆçª— -->
<div id="addFriendModal" class="modal">
  <div class="modal-content">
    <h3>è¼¸å…¥å¥½å‹ ID</h3>
    <input type="text" id="friendIdInput" placeholder="å¥½å‹ID" />
    <div class="modal-buttons">
      <button id="confirmAddFriend" class="btn-primary">ç¢ºèª</button>
      <button id="cancelAddFriend" class="btn-secondary">å–æ¶ˆ</button>
    </div>
    <p id="addFriendMsg" class="msg-error"></p>
  </div>
</div>

<!-- ç¢ºèªå°è©±æ¡† -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3 id="confirmTitle">ç¢ºèªæ“ä½œ</h3>
    <p id="confirmMessage">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
    <div class="modal-buttons">
      <button id="confirmYes" class="btn-danger">ç¢ºèª</button>
      <button id="confirmNo" class="btn-secondary">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- é ­åƒé¸å–® -->
<div id="avatar-menu">
  <div class="avatar-menu-item">å€‹äººè³‡æ–™</div>
  <div class="avatar-menu-item">ç‹€æ…‹è¨­å®š</div>
  <div class="avatar-menu-item" id="logout-btn">ç™»å‡º</div>
</div>
<script>
  if (!localStorage.getItem("uid") || !localStorage.getItem("userEmail")) {
    window.location.href = "index.html";
  }
</script>

<script>

    switchPage('home');

  // Firebase åˆå§‹åŒ–
  const firebaseConfig = {
    apiKey: "AIzaSyBdrLtJihqOdIhvODvtLaUXZozOlXmxPAI",
    authDomain: "faycrchat.firebaseapp.com",
    projectId: "faycrchat",
    storageBucket: "faycrchat.appspot.com",
    messagingSenderId: "569359638648",
    appId: "1:569359638648:web:73a05e760fd2af90608d8d",
    measurementId: "G-LTBL20K38K"
  };
  
  console.log("åˆå§‹åŒ– Firebase...");
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // èª¿è©¦ç”¨å‡½æ•¸
  function updateDebugInfo(key, value, isError = false) {
    const element = document.getElementById(`debug${key}`);
    if (element) {
      element.textContent = value;
      if (isError) {
        element.parentElement.classList.add('debug-error');
      } else {
        element.parentElement.classList.remove('debug-error');
      }
    }
  }

  // ç”¨æˆ¶è³‡æ–™
  const userEmail = localStorage.getItem("userEmail") || "test@example.com";
  const displayName = userEmail.split("@")[0];
  const uid = localStorage.getItem("uid") || userEmail.replace(/[^a-zA-Z0-9]/g, "_");

  console.log("ç”¨æˆ¶è³‡æ–™:", { userEmail, displayName, uid });
  updateDebugInfo("Uid", uid);

  // å…¨å±€è®Šæ•¸
  let currentFriendUid = null;
  let currentGroupId = null;
  let currentGroupData = null;
  let unsubscribeMessages = null;
  let unsubscribeGroups = null;
  let replyToMessageId = null;
  let actionMenuEl = null;
  let messageToDelete = null;
  let userFriends = [];

  // å·¦å´é¸å–®åˆ‡æ›åŠŸèƒ½
  function switchPage(pageName) {
  // æ¡Œé¢ç‰ˆé€»è¾‘
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });
  
  document.querySelectorAll('.main-menu-item').forEach(item => {
    item.classList.remove('active');
  });
  
  const targetPage = document.getElementById(pageName + '-page');
  if (targetPage) {
    targetPage.classList.add('active');
  }
  
  const activeMenuItem = document.querySelector(`[data-page="${pageName}"]`);
  if (activeMenuItem) {
    activeMenuItem.classList.add('active');
  }
  
  // æ‰‹æœºç‰ˆç‰¹æ®Šå¤„ç†
  if (window.innerWidth <= 768) {
    const middleSidebar = document.getElementById('middle-sidebar');
    const chatContainer = document.getElementById('chat-container');
    
    if (pageName === 'messages' && currentGroupId) {
      // å¦‚æœåœ¨messagesé¡µé¢ä¸”å·²é€‰æ‹©ç¾¤ç»„ï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
      middleSidebar.classList.remove('mobile-show');
      chatContainer.classList.remove('mobile-hide');
    } else if (pageName === 'home') {
      // ä¸»é¡µç›´æ¥æ˜¾ç¤ºèŠå¤©åŒº
      middleSidebar.classList.remove('mobile-show');
      chatContainer.classList.remove('mobile-hide');
    } else {
      // å…¶ä»–é¡µé¢æ˜¾ç¤ºä¸­é—´æ 
      middleSidebar.classList.add('mobile-show');
      chatContainer.classList.add('mobile-hide');
    }
  }
}

  // ç‚ºå·¦å´é¸å–®é …æ·»åŠ é»æ“Šäº‹ä»¶
  document.querySelectorAll('.main-menu-item[data-page]').forEach(item => {
    item.addEventListener('click', () => {
      const pageName = item.getAttribute('data-page');
      switchPage(pageName);
    });
  });

  // ç¢ºä¿ç”¨æˆ¶æœ‰ friendId
  async function ensureFriendId() {
    console.log("ç¢ºä¿ç”¨æˆ¶æœ‰ friendId...");
    try {
      const userRef = db.collection("users").doc(uid);
      const userDoc = await userRef.get();
      let friendId;
      
      if (userDoc.exists && userDoc.data().friendId) {
        console.log("ç”¨æˆ¶å·²æœ‰ friendId:", userDoc.data().friendId);
        return userDoc.data().friendId;
      }

      friendId = displayName;
      if (!/^[a-zA-Z0-9]+$/.test(friendId)) {
        friendId = "user" + Math.random().toString(36).substring(2, 8);
      }
      
      let exists = true;
      while (exists) {
        const snap = await db.collection("users").where("friendId", "==", friendId).get();
        if (!snap.empty) {
          friendId = "user" + Math.random().toString(36).substring(2, 8);
        } else {
          exists = false;
        }
      }
      
      await userRef.set({
        email: userEmail,
        displayName: displayName,
        avatar: "https://i.imgur.com/4Z7hFfK.png",
        friends: [],
        friendId: friendId
      }, { merge: true });
      
      console.log("å»ºç«‹æ–°ç”¨æˆ¶è³‡æ–™ï¼ŒfriendId:", friendId);
      return friendId;
    } catch (error) {
      console.error("ç¢ºä¿ç”¨æˆ¶ friendId å¤±æ•—:", error);
      updateDebugInfo("Firebase", "ç”¨æˆ¶è³‡æ–™åˆå§‹åŒ–å¤±æ•—", true);
      throw error;
    }
  }

  // ç›£è½ç”¨æˆ¶å¥½å‹åˆ—è¡¨
  function listenFriendList() {
    console.log("é–‹å§‹ç›£è½å¥½å‹åˆ—è¡¨...");
    db.collection("users").doc(uid).onSnapshot(doc => {
      if (doc.exists) {
        userFriends = doc.data().friends || [];
        console.log("å¥½å‹åˆ—è¡¨æ›´æ–°:", userFriends);
        renderFriendList(userFriends, "friendsList");
        renderFriendList(userFriends, "messagesFriendsList");
      } else {
        console.log("ç”¨æˆ¶æ–‡æª”ä¸å­˜åœ¨ï¼Œé¡¯ç¤ºæ¸¬è©¦å¥½å‹");
        renderTestFriends("friendsList");
        renderTestFriends("messagesFriendsList");
      }
    }, (error) => {
      console.error("ç›£è½å¥½å‹åˆ—è¡¨å¤±æ•—:", error);
      renderTestFriends("friendsList");
      renderTestFriends("messagesFriendsList");
    });
  }

  // ç¾¤çµ„åˆ—è¡¨ç›£è½
function listenGroupList() {
  const groupsList = document.getElementById("groupsList");
  groupsList.innerHTML = `<div class="loading">è¼‰å…¥ä¸­...</div>`;

  if (unsubscribeGroups) unsubscribeGroups();

  unsubscribeGroups = db.collection("groups")
    .where("members", "array-contains", uid)
    .orderBy("updatedAt", "desc")
    .onSnapshot(snapshot => {
      groupsList.innerHTML = "";
      if (snapshot.empty) {
        groupsList.innerHTML = `
          <div class="empty-state">
            <h3>ğŸ“­ æ²’æœ‰ç¾¤çµ„</h3>
            <p>å¿«å»ºç«‹ä¸€å€‹ç¾¤çµ„é–‹å§‹èŠå¤©å§ï¼</p>
          </div>`;
        return;
      }
      snapshot.forEach(doc => {
        const data = doc.data();
        const groupItem = document.createElement("div");
        groupItem.classList.add("group-item");
        groupItem.setAttribute("data-group-id", doc.id);
        groupItem.innerHTML = `
          <div style="flex: 1;">
            <div class="group-name">${data.name}</div>
            <div class="group-info">${data.lastMessage ? `${data.lastMessage.sender}: ${data.lastMessage.text}` : "å°šç„¡è¨Šæ¯"}</div>
          </div>
        `;
        groupItem.onclick = () => openGroupChat(doc.id, data);
        groupsList.appendChild(groupItem);
      });
    }, (error) => {
      console.error("è¼‰å…¥ç¾¤çµ„åˆ—è¡¨éŒ¯èª¤:", error);
      let errorHTML = `
        <div class="empty-state">
          <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
          <p>${error.message}</p>
      `;
      // åµæ¸¬ç´¢å¼•éŒ¯èª¤
      if (error.code === "failed-precondition" && error.message.includes("index")) {
        // å˜—è©¦æå– URL
        const urlMatch = error.message.match(/https:\/\/[^\s]+/);
        if (urlMatch) {
          errorHTML += `<p><a href="${urlMatch[0]}" target="_blank" style="color: #4cafef;">ğŸ“Œ é»æ­¤å»ºç«‹ç´¢å¼•</a></p>`;
        }
      }
      errorHTML += `<button onclick="listenGroupList()">é‡è©¦</button></div>`;
      groupsList.innerHTML = errorHTML;
    });
}

  // é‡è©¦è¼‰å…¥ç¾¤çµ„
  function retryLoadGroups() {
    console.log("é‡è©¦è¼‰å…¥ç¾¤çµ„...");
    document.getElementById("groupsList").innerHTML = `
      <div class="empty-state">
        <h3>ğŸ”„ é‡æ–°è¼‰å…¥ä¸­...</h3>
        <p>æ­£åœ¨é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨...</p>
      </div>
    `;
    listenGroupList();
  }

  // å»ºç«‹æ¸¬è©¦ç¾¤çµ„
  async function createTestGroup() {
    console.log("å»ºç«‹æ¸¬è©¦ç¾¤çµ„...");
    try {
      const groupData = {
        name: "æ¸¬è©¦ç¾¤çµ„",
        description: "é€™æ˜¯ä¸€å€‹æ¸¬è©¦ç¾¤çµ„",
        owner: uid,
        admins: [uid],
        members: [uid],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      const docRef = await db.collection("groups").add(groupData);
      console.log("æ¸¬è©¦ç¾¤çµ„å»ºç«‹æˆåŠŸ:", docRef.id);
      
      // ç™¼é€æ­¡è¿è¨Šæ¯
      await db.collection("groupChats").doc(docRef.id).collection("messages").add({
        sender: "ç³»çµ±",
        senderUid: "system",
        type: "system",
        text: "æ­¡è¿ä¾†åˆ°æ¸¬è©¦ç¾¤çµ„ï¼",
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
      });
      
    } catch (error) {
      console.error("å»ºç«‹æ¸¬è©¦ç¾¤çµ„å¤±æ•—:", error);
      alert("å»ºç«‹æ¸¬è©¦ç¾¤çµ„å¤±æ•—: " + error.message);
    }
  }

  // é–‹å•Ÿç¾¤çµ„èŠå¤©
  function openGroupChat(groupId, groupData) {
    console.log("é–‹å•Ÿç¾¤çµ„èŠå¤©:", groupId, groupData.name);
    
    currentGroupId = groupId;
    currentGroupData = groupData;
    currentFriendUid = null;
    
    // æ›´æ–°UIç‹€æ…‹
    document.querySelectorAll('.group-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[data-group-id="${groupId}"]`)?.classList.add('active');
    
    // æ›´æ–°èŠå¤©é ­éƒ¨
    document.querySelector('.chat-header-title').textContent = groupData.name;
    document.getElementById('chatHeaderSubtitle').textContent = `${groupData.members ? groupData.members.length : 0} ä½æˆå“¡`;
    document.getElementById('chatHeaderActions').style.display = 'flex';
    
    // å•Ÿç”¨è¼¸å…¥å€åŸŸ
    document.getElementById("messageInput").disabled = false;
    document.getElementById("sendBtn").disabled = false;
    document.getElementById("fileBtn").disabled = false;
    
    // ç›£è½ç¾¤çµ„è¨Šæ¯
    if (unsubscribeMessages) unsubscribeMessages();
    unsubscribeMessages = db.collection("groupChats").doc(groupId)
      .collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        renderMessages(snapshot);
      }, (error) => {
        console.error("ç›£è½è¨Šæ¯å¤±æ•—:", error);
        document.getElementById("messages").innerHTML = `
          <div class="empty-state">
            <h3>âŒ è¼‰å…¥è¨Šæ¯å¤±æ•—</h3>
            <p>ç„¡æ³•è¼‰å…¥èŠå¤©è¨Šæ¯: ${error.message}</p>
          </div>
        `;
      });
      // ç›£è½ç¾¤çµ„è³‡æ–™è®ŠåŒ–ï¼ˆä¾‹å¦‚æˆå“¡æ•¸ï¼‰
if (window.unsubscribeGroupData) unsubscribeGroupData();
unsubscribeGroupData = db.collection("groups").doc(groupId).onSnapshot(doc => {
  if (doc.exists) {
    currentGroupData = doc.data();
    document.getElementById('chatHeaderSubtitle').textContent =
      `${currentGroupData.members ? currentGroupData.members.length : 0} ä½æˆå“¡`;
      // åœ¨ openGroupChat å‡½æ•°çš„æœ€åæ·»åŠ 
if (window.innerWidth <= 768) {
  // æ‰‹æœºç‰ˆï¼šé€‰æ‹©ç¾¤ç»„åè‡ªåŠ¨åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
  document.getElementById('middle-sidebar').classList.remove('mobile-show');
  document.getElementById('chat-container').classList.remove('mobile-hide');
}
  }
});

  }

  // æ¸²æŸ“è¨Šæ¯
  function renderMessages(snapshot) {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";
    
    if (snapshot.empty) {
      messagesDiv.innerHTML = `
        <div class="empty-state">
          <h3>ğŸ‘‹ é–‹å§‹èŠå¤©å§ï¼</h3>
          <p>é€™å€‹ç¾¤çµ„é‚„æ²’æœ‰è¨Šæ¯ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç™¼è¨€çš„äººå§ï¼</p>
        </div>
      `;
      return;
    }
    
    snapshot.forEach(doc => {
      const data = doc.data();
      const wrapper = document.createElement("div");
      wrapper.classList.add("message-wrapper");
      wrapper.id = `msg-${doc.id}`;
      
      const msgEl = document.createElement("div");
      msgEl.classList.add("message", data.sender === displayName ? "self" : "other");

      // å›è¦†å¼•ç”¨
      if (data.replyTo) {
        const replyRef = document.createElement("div");
        replyRef.classList.add("reply-reference");
        replyRef.textContent = "å›è¦†å…§å®¹ï¼šè¼‰å…¥ä¸­...";
        replyRef.onclick = () => scrollToMessage(data.replyTo);
        
        // è¼‰å…¥è¢«å›è¦†çš„è¨Šæ¯
        db.collection("groupChats").doc(currentGroupId).collection("messages").doc(data.replyTo)
          .get().then(rDoc => {
            if (rDoc.exists) {
              const replyData = rDoc.data();
              const previewText = getMessagePreview(replyData);
              replyRef.textContent = `å›è¦† ${replyData.sender}: ${previewText}`;
            }
          });
        msgEl.appendChild(replyRef);
      }

      // è¨Šæ¯å…§å®¹
      const contentDiv = document.createElement("div");
      if (data.type === "image") {
        const img = document.createElement("img");
        img.src = data.url;
        img.classList.add("chat-image");
        img.onerror = () => {
          img.style.display = 'none';
          contentDiv.innerHTML = `<div style="color: #999;">[åœ–ç‰‡è¼‰å…¥å¤±æ•—]</div>`;
        };
        contentDiv.appendChild(img);
      } else if (data.type === "file") {
        const fileDiv = document.createElement("div");
        fileDiv.innerHTML = `ğŸ“ `;
        const a = document.createElement("a");
        a.href = data.url;
        a.textContent = data.fileName || "ä¸‹è¼‰æª”æ¡ˆ";
        a.target = "_blank";
        a.style.color = "blue";
        a.style.textDecoration = "underline";
        fileDiv.appendChild(a);
        contentDiv.appendChild(fileDiv);
      } else {
        const linkRegex = /(https:\/\/[^\s]+)/g;
        const safeText = (data.text || '').replace(linkRegex, url => {
          return `<a href="${url}" target="_blank" style="color:blue;text-decoration:underline;">${url}</a>`;
        });
        contentDiv.innerHTML = `<strong>${data.sender}:</strong> ${safeText}`;
      }
      msgEl.appendChild(contentDiv);

// è‡ªå‹•æ¨™è¨˜å·²è®€
if (!data.readBy?.includes(uid) && data.senderUid !== uid) {
  // å»¶é²æ¨™è¨˜å·²è®€ï¼Œé¿å…ç«‹å³æ¨™è¨˜
  setTimeout(() => {
    try {
      if (currentGroupId) {
        db.collection("groupChats").doc(currentGroupId)
          .collection("messages").doc(doc.id)
          .update({
            readBy: firebase.firestore.FieldValue.arrayUnion(uid)
          });
      } else if (currentFriendUid) {
        const chatId = getChatId(uid, currentFriendUid);
        db.collection("chats").doc(chatId)
          .collection("messages").doc(doc.id)
          .update({
            readBy: firebase.firestore.FieldValue.arrayUnion(uid)
          });
      }
    } catch (error) {
      console.log("æ¨™è¨˜å·²è®€å¤±æ•—:", error);
    }
  }, 800);
}


// é¡¯ç¤ºç™¼é€æ™‚é–“èˆ‡å·²è®€äººæ•¸ï¼ˆå…©è¡Œæ ¼å¼ï¼‰
const metaDiv = document.createElement("div");
metaDiv.style.fontSize = "10px";
metaDiv.style.color = "#888";
metaDiv.style.marginTop = "2px";
metaDiv.style.whiteSpace = "pre-line"; // æ”¯æ´æ›è¡Œ
metaDiv.classList.add('meta-info');

// ç™¼é€æ™‚é–“æ ¼å¼åŒ–
let timeStr = "å‚³é€ä¸­...";
if (data.timestamp?.toDate) {
  const dateObj = data.timestamp.toDate();
  const now = new Date();
  const isToday = dateObj.toDateString() === now.toDateString();
  
  let hours = dateObj.getHours();
  const minutes = String(dateObj.getMinutes()).padStart(2, "0");
  const period = hours >= 12 ? "ä¸‹åˆ" : "ä¸Šåˆ";
  if (hours > 12) hours -= 12;
  if (hours === 0) hours = 12;
  
  if (isToday) {
    timeStr = `${period}${hours}:${minutes}`;
  } else {
    const month = String(dateObj.getMonth() + 1).padStart(2, "0");
    const day = String(dateObj.getDate()).padStart(2, "0");
    timeStr = `${month}/${day} ${period}${hours}:${minutes}`;
  }
}

// å·²è®€äººæ•¸
const readCount = (data.readBy?.length || 0);
metaDiv.textContent = `${timeStr}\nå·²è®€ ${readCount}`;

msgEl.appendChild(metaDiv);


      // Emoji åæ‡‰
      if (data.reactions) {
        const reactionsDiv = document.createElement("div");
        reactionsDiv.classList.add("reactions");
        Object.entries(data.reactions).forEach(([emoji, users]) => {
          if (users && users.length > 0) {
            const reactionSpan = document.createElement("span");
            reactionSpan.classList.add("reaction");
            reactionSpan.textContent = `${emoji} ${users.length}`;
            reactionSpan.onclick = () => toggleReaction(doc.id, emoji);
            reactionsDiv.appendChild(reactionSpan);
          }
        });
        if (reactionsDiv.children.length > 0) {
          msgEl.appendChild(reactionsDiv);
        }
      }

      // ä¸‰é»é¸å–®æŒ‰éˆ•
      const moreBtn = document.createElement("button");
      moreBtn.textContent = "â‹¯";
      moreBtn.classList.add("more-btn");
      moreBtn.onclick = (e) => showActionMenu(e, doc.id, data);
      
      wrapper.appendChild(msgEl);
      wrapper.appendChild(moreBtn);
      messagesDiv.appendChild(wrapper);
    });
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // ç²å–è¨Šæ¯é è¦½æ–‡å­—
  function getMessagePreview(messageData) {
    if (messageData.text) {
      return messageData.text.length > 50 ? messageData.text.slice(0, 50) + '...' : messageData.text;
    }
    switch (messageData.type) {
      case 'image': return '[åœ–ç‰‡]';
      case 'file': return '[æª”æ¡ˆ]';
      default: return '[è¨Šæ¯]';
    }
  }

  // æ»¾å‹•åˆ°æŒ‡å®šè¨Šæ¯
  function scrollToMessage(messageId) {
    const targetEl = document.getElementById(`msg-${messageId}`);
    if (targetEl) {
      targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      targetEl.style.backgroundColor = '#fffbcc';
      setTimeout(() => targetEl.style.backgroundColor = '', 2000);
    }
  }

  // ç™¼é€è¨Šæ¯
  function sendMessage() {
    const messageInput = document.getElementById("messageInput");
    const text = messageInput.value.trim();
    if (!text || !currentGroupId) return;

    console.log("ç™¼é€è¨Šæ¯:", text);

    const msgData = {
      sender: displayName,
      senderUid: uid,
      type: "text",
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
    };

    // å¦‚æœæœ‰å›è¦†ï¼ŒåŠ å…¥å›è¦†è³‡è¨Š
    if (replyToMessageId) {
      msgData.replyTo = replyToMessageId;
    }

    // ç™¼é€åˆ°ç¾¤çµ„èŠå¤©
    db.collection("groupChats").doc(currentGroupId).collection("messages").add(msgData)
      .then(() => {
        // æ›´æ–°ç¾¤çµ„çš„æœ€å¾Œæ´»å‹•æ™‚é–“
        return db.collection("groups").doc(currentGroupId).update({
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastMessage: {
            sender: displayName,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
          }
        });
      })
      .then(() => {
        console.log("è¨Šæ¯ç™¼é€æˆåŠŸ");
      })
      .catch(error => {
        console.error("ç™¼é€è¨Šæ¯å¤±æ•—:", error);
        alert("ç™¼é€è¨Šæ¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦: " + error.message);
      });

    // æ¸…é™¤å›è¦†ç‹€æ…‹å’Œè¼¸å…¥æ¡†
    replyToMessageId = null;
    document.getElementById("replyBox").style.display = "none";
    messageInput.value = "";
  }

  // ä¸Šå‚³æª”æ¡ˆ
  function uploadFile(file, type) {
    if (!currentGroupId) return;
    
    const storageRef = storage.ref(`groupFiles/${currentGroupId}/${Date.now()}_${file.name}`);
    
    storageRef.put(file).then(snapshot => {
      return snapshot.ref.getDownloadURL();
    }).then(url => {
      const msgData = {
        sender: displayName,
        senderUid: uid,
        type: type,
        url: url,
        fileName: file.name,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
      };

      // å¦‚æœæœ‰å›è¦†ï¼ŒåŠ å…¥å›è¦†è³‡è¨Š
      if (replyToMessageId) {
        msgData.replyTo = replyToMessageId;
      }

      return db.collection("groupChats").doc(currentGroupId).collection("messages").add(msgData);
    }).then(() => {
      // æ›´æ–°ç¾¤çµ„æœ€å¾Œæ´»å‹•æ™‚é–“
      return db.collection("groups").doc(currentGroupId).update({
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessage: {
          sender: displayName,
          text: type === 'image' ? '[åœ–ç‰‡]' : '[æª”æ¡ˆ]',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
        }
      });
    }).then(() => {
      // æ¸…é™¤å›è¦†ç‹€æ…‹
      replyToMessageId = null;
      document.getElementById("replyBox").style.display = "none";
    }).catch(error => {
      console.error("ä¸Šå‚³æª”æ¡ˆå¤±æ•—:", error);
      alert("ä¸Šå‚³æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    });
  }

  // é¡¯ç¤ºè¨Šæ¯æ“ä½œé¸å–®
  function showActionMenu(e, messageId, messageData) {
    e.stopPropagation();
    if (actionMenuEl) actionMenuEl.remove();

    actionMenuEl = document.createElement("div");
    actionMenuEl.classList.add("action-menu");
    actionMenuEl.style.top = Math.min(e.clientY, window.innerHeight - 200) + "px";
    actionMenuEl.style.left = Math.min(e.clientX, window.innerWidth - 150) + "px";

    // å›è¦†åŠŸèƒ½
    const reply = document.createElement("div");
    reply.textContent = "å›è¦†è¨Šæ¯";
    reply.onclick = () => {
      replyToMessageId = messageId;
      document.getElementById("replyUser").textContent = messageData.sender;
      document.getElementById("replyText").textContent = getMessagePreview(messageData);
      document.getElementById("replyBox").style.display = "block";
      actionMenuEl.remove();
    };
    actionMenuEl.appendChild(reply);

    // å¦‚æœæ˜¯è‡ªå·±çš„è¨Šæ¯ï¼Œé¡¯ç¤ºæ”¶å›é¸é …
    if (messageData.senderUid === uid) {
      const recall = document.createElement("div");
      recall.textContent = "æ”¶å›è¨Šæ¯";
      recall.style.color = "#e53e3e";
      recall.onclick = () => {
        messageToDelete = messageId;
        document.getElementById("confirmTitle").textContent = "ç¢ºèªæ”¶å›è¨Šæ¯";
        document.getElementById("confirmMessage").textContent = "ç¢ºå®šè¦æ”¶å›é€™å‰‡è¨Šæ¯å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚";
        document.getElementById("confirmModal").style.display = "flex";
        actionMenuEl.remove();
      };
      actionMenuEl.appendChild(recall);
    }
if (data.senderUid === uid) {
  if (readCount <= 1) {
    readText = "âœ“"; // å·²ç™¼é€
  } else {
    readText = `âœ“âœ“ ${readCount}`; // å·²è®€äººæ•¸
  }
}
    // Emoji åæ‡‰
    const emojiRow = document.createElement("div");
    emojiRow.style.padding = "8px 12px";
    emojiRow.style.display = "flex";
    emojiRow.style.gap = "5px";
    ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡'].forEach(emoji => {
      const btn = document.createElement("span");
      btn.textContent = emoji;
      btn.style.cursor = "pointer";
      btn.style.padding = "4px";
      btn.style.borderRadius = "4px";
      btn.onclick = () => {
        toggleReaction(messageId, emoji);
        actionMenuEl.remove();
      };
      btn.onmouseenter = () => btn.style.backgroundColor = "#f0f0f0";
      btn.onmouseleave = () => btn.style.backgroundColor = "";
      emojiRow.appendChild(btn);
    });
    actionMenuEl.appendChild(emojiRow);

    document.body.appendChild(actionMenuEl);
  }

  // åˆ‡æ› Emoji åæ‡‰
  function toggleReaction(messageId, emoji) {
    if (!currentGroupId) return;
    
    const messageRef = db.collection("groupChats").doc(currentGroupId).collection("messages").doc(messageId);
    
    db.runTransaction(transaction => {
      return transaction.get(messageRef).then(doc => {
        if (!doc.exists) throw new Error("è¨Šæ¯ä¸å­˜åœ¨");
        
        const data = doc.data();
        const reactions = data.reactions || {};
        const users = reactions[emoji] || [];
        
        if (users.includes(uid)) {
          // ç§»é™¤åæ‡‰
          reactions[emoji] = users.filter(u => u !== uid);
          if (reactions[emoji].length === 0) {
            delete reactions[emoji];
          }
        } else {
          // æ·»åŠ åæ‡‰
          reactions[emoji] = [...users, uid];
        }
        
        transaction.update(messageRef, { reactions });
      });
    }).catch(error => {
      console.error("æ›´æ–°åæ‡‰å¤±æ•—:", error);
    });
  }

  // å»ºç«‹ç¾¤çµ„
  async function createGroup() {
    const name = document.getElementById("groupNameInput").value.trim();
    const description = document.getElementById("groupDescInput").value.trim();
    const msgEl = document.getElementById("createGroupMsg");
    
    if (!name) {
      msgEl.textContent = "è«‹è¼¸å…¥ç¾¤çµ„åç¨±";
      return;
    }
    
    msgEl.textContent = "";

    try {
      const groupData = {
        name: name,
        description: description || "",
        owner: uid,
        admins: [uid],
        members: [uid],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      const docRef = await db.collection("groups").add(groupData);
      
      // é—œé–‰ modal ä¸¦æ¸…ç©ºæ¬„ä½
      closeModal("createGroupModal");
      document.getElementById("groupNameInput").value = "";
      document.getElementById("groupDescInput").value = "";
      
      // è‡ªå‹•é–‹å•Ÿå‰›å»ºç«‹çš„ç¾¤çµ„
      openGroupChat(docRef.id, {...groupData, id: docRef.id});

      if (!groupDoc.exists || !groupDoc.data().members.includes(uid)) {
  alert("ç¾¤çµ„ä¸å­˜åœ¨æˆ–æ‚¨å·²ä¸åœ¨ç¾¤çµ„å…§");
  return;
}

      
    } catch (error) {
      console.error("å»ºç«‹ç¾¤çµ„å¤±æ•—:", error);
      msgEl.textContent = "å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
  }

  // è¼‰å…¥å¥½å‹é¸æ“‡åˆ—è¡¨
  async function loadFriendSelectList() {
    const container = document.getElementById("friendSelectList");
    container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">è¼‰å…¥ä¸­...</div>';
    
    try {
      if (!userFriends.length) {
        container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">é‚„æ²’æœ‰å¥½å‹å¯ä»¥é‚€è«‹</div>';
        return;
      }
      
      container.innerHTML = '';
      
      // ç²å–ç¾¤çµ„ç¾æœ‰æˆå“¡ï¼ˆé¿å…é‡è¤‡é‚€è«‹ï¼‰
      const groupDoc = await db.collection("groups").doc(currentGroupId).get();
      const existingMembers = groupDoc.exists ? groupDoc.data().members : [];
      
      for (const friendUid of userFriends) {
        if (existingMembers.includes(friendUid)) continue; // è·³éå·²æ˜¯æˆå“¡çš„å¥½å‹
        
        try {
          const friendDoc = await db.collection("users").doc(friendUid).get();
          if (friendDoc.exists) {
            const friendData = friendDoc.data();
            const item = document.createElement("div");
            item.classList.add("friend-select-item");
            item.innerHTML = `
              <input type="checkbox" value="${friendUid}" id="friend-${friendUid}">
              <label for="friend-${friendUid}">${friendData.displayName}</label>
            `;
            container.appendChild(item);
          }
        } catch (error) {
          console.error("è¼‰å…¥å¥½å‹è³‡æ–™å¤±æ•—:", friendUid, error);
        }
      }
      
      if (container.children.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">æ‰€æœ‰å¥½å‹éƒ½å·²åœ¨ç¾¤çµ„ä¸­</div>';
      }
      
    } catch (error) {
      console.error("è¼‰å…¥å¥½å‹åˆ—è¡¨å¤±æ•—:", error);
      container.innerHTML = '<div style="text-align: center; color: #e53e3e; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
    }
  }

  // é‚€è«‹æˆå“¡åŠ å…¥ç¾¤çµ„
  async function inviteMembers() {
    const checkboxes = document.querySelectorAll('#friendSelectList input[type="checkbox"]:checked');
    const msgEl = document.getElementById("inviteMembersMsg");
    
    if (checkboxes.length === 0) {
      msgEl.textContent = "è«‹é¸æ“‡è¦é‚€è«‹çš„å¥½å‹";
      return;
    }
    
    msgEl.textContent = "";
    
    try {
      const selectedFriends = Array.from(checkboxes).map(cb => cb.value);
      
      // æ›´æ–°ç¾¤çµ„æˆå“¡åˆ—è¡¨
      await db.collection("groups").doc(currentGroupId).update({
        members: firebase.firestore.FieldValue.arrayUnion(...selectedFriends),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // ç™¼é€ç³»çµ±è¨Šæ¯
      const inviteMessage = {
        sender: "ç³»çµ±",
        senderUid: "system",
        type: "system",
        text: `${displayName} é‚€è«‹äº† ${selectedFriends.length} ä½æ–°æˆå“¡åŠ å…¥ç¾¤çµ„`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
      };
      
      await db.collection("groupChats").doc(currentGroupId).collection("messages").add(inviteMessage);
      
      closeModal("inviteMembersModal");
      msgEl.classList.add("msg-success");
      msgEl.textContent = "é‚€è«‹æˆåŠŸï¼";
      
      setTimeout(() => {
        msgEl.textContent = "";
        msgEl.classList.remove("msg-success");
      }, 2000);
      // é‡æ–°è¼‰å…¥ç¾¤çµ„è¨­å®šå’Œæˆå“¡æ•¸
const groupDoc = await db.collection("groups").doc(currentGroupId).get();
if (groupDoc.exists) {
  currentGroupData = groupDoc.data();
  document.getElementById('chatHeaderSubtitle').textContent =
    `${currentGroupData.members ? currentGroupData.members.length : 0} ä½æˆå“¡`;
}

    } catch (error) {
      console.error("é‚€è«‹æˆå“¡å¤±æ•—:", error);
      msgEl.textContent = "é‚€è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
  }

  // è¼‰å…¥ç¾¤çµ„è¨­å®š
  async function loadGroupSettings() {
    // é‡æ–°æŠ“ç¾¤çµ„æœ€æ–°è³‡æ–™
try {
  const groupDoc = await db.collection("groups").doc(currentGroupId).get();
  if (groupDoc.exists) {
    currentGroupData = groupDoc.data();
  }
} catch (err) {
  console.error("è¼‰å…¥ç¾¤çµ„è³‡æ–™å¤±æ•—", err);
}

    if (!currentGroupId || !currentGroupData) return;
    
    // å¡«å…¥ç¾¤çµ„åŸºæœ¬è³‡è¨Š
    document.getElementById("editGroupName").value = currentGroupData.name;
    document.getElementById("editGroupDesc").value = currentGroupData.description || "";
    
    // è¼‰å…¥æˆå“¡åˆ—è¡¨
    const memberList = document.getElementById("memberList");
    const memberCount = document.getElementById("memberCount");
    memberList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">è¼‰å…¥ä¸­...</div>';
    
    try {
      const memberPromises = currentGroupData.members.map(async (memberUid) => {
        try {
          const userDoc = await db.collection("users").doc(memberUid).get();
          return {
            uid: memberUid,
            data: userDoc.exists ? userDoc.data() : { displayName: "æœªçŸ¥ç”¨æˆ¶" }
          };
        } catch (error) {
          return {
            uid: memberUid,
            data: { displayName: "è¼‰å…¥å¤±æ•—" }
          };
        }
      });
      
      const members = await Promise.all(memberPromises);
      memberList.innerHTML = "";
      memberCount.textContent = members.length;
      
      members.forEach(({ uid: memberUid, data }) => {
        const item = document.createElement("div");
        item.classList.add("member-item");
        
        const isOwner = memberUid === currentGroupData.owner;
        const isAdmin = currentGroupData.admins && currentGroupData.admins.includes(memberUid);
        const canManage = uid === currentGroupData.owner || (currentGroupData.admins && currentGroupData.admins.includes(uid));
        
        let roleText = "";
        if (isOwner) roleText = "ç¾¤ä¸»";
        else if (isAdmin) roleText = "ç®¡ç†å“¡";
        
        item.innerHTML = `
          <div class="member-info">
            <span class="member-name">${data.displayName}</span>
            ${roleText ? `<span class="member-role">${roleText}</span>` : ""}
          </div>
        `;
        
        // å¦‚æœæœ‰ç®¡ç†æ¬Šé™ä¸”ä¸æ˜¯å°è‡ªå·±æ“ä½œ
        if (canManage && memberUid !== uid && !isOwner) {
          const actions = document.createElement("div");
          actions.classList.add("member-actions");
          
          if (!isAdmin) {
            const promoteBtn = document.createElement("button");
            promoteBtn.textContent = "è¨­ç‚ºç®¡ç†å“¡";
            promoteBtn.style.background = "#48bb78";
            promoteBtn.style.color = "white";
            promoteBtn.onclick = () => promoteMember(memberUid, data.displayName);
            actions.appendChild(promoteBtn);
          }
          
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "ç§»é™¤";
          removeBtn.style.background = "#e53e3e";
          removeBtn.style.color = "white";
          removeBtn.onclick = () => removeMember(memberUid, data.displayName);
          actions.appendChild(removeBtn);
          
          item.appendChild(actions);
        }
        
        memberList.appendChild(item);
      });
      
    } catch (error) {
      console.error("è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—:", error);
      memberList.innerHTML = '<div style="text-align: center; color: #e53e3e; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
    }
  }

  // å„²å­˜ç¾¤çµ„è¨­å®š
  async function saveGroupSettings() {
    const name = document.getElementById("editGroupName").value.trim();
    const description = document.getElementById("editGroupDesc").value.trim();
    const msgEl = document.getElementById("groupSettingsMsg");
    
    if (!name) {
      msgEl.textContent = "ç¾¤çµ„åç¨±ä¸èƒ½ç‚ºç©º";
      return;
    }
    
    try {
      await db.collection("groups").doc(currentGroupId).update({
        name: name,
        description: description,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // æ›´æ–°ç•¶å‰ç¾¤çµ„è³‡æ–™
      currentGroupData.name = name;
      currentGroupData.description = description;
      
      // æ›´æ–°UI
      document.querySelector('.chat-header-title').textContent = name;
      
      closeModal("groupSettingsModal");
      
    } catch (error) {
      console.error("å„²å­˜ç¾¤çµ„è¨­å®šå¤±æ•—:", error);
      msgEl.textContent = "å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
  }

  // æå‡æˆå“¡ç‚ºç®¡ç†å“¡
  async function promoteMember(memberUid, memberName) {
    if (!confirm(`ç¢ºå®šè¦å°‡ ${memberName} è¨­ç‚ºç®¡ç†å“¡å—ï¼Ÿ`)) return;
    
    try {
      await db.collection("groups").doc(currentGroupId).update({
        admins: firebase.firestore.FieldValue.arrayUnion(memberUid),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // é‡æ–°è¼‰å…¥è¨­å®š
      const groupDoc = await db.collection("groups").doc(currentGroupId).get();
      if (groupDoc.exists) {
        currentGroupData = groupDoc.data();
        loadGroupSettings();
      }
      
    } catch (error) {
      console.error("æå‡ç®¡ç†å“¡å¤±æ•—:", error);
      alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  // ç§»é™¤ç¾¤çµ„æˆå“¡
  async function removeMember(memberUid, memberName) {
    if (!confirm(`ç¢ºå®šè¦å°‡ ${memberName} ç§»å‡ºç¾¤çµ„å—ï¼Ÿ`)) return;
    
    try {
      await db.collection("groups").doc(currentGroupId).update({
        members: firebase.firestore.FieldValue.arrayRemove(memberUid),
        admins: firebase.firestore.FieldValue.arrayRemove(memberUid),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // ç™¼é€ç³»çµ±è¨Šæ¯
      const removeMessage = {
        sender: "ç³»çµ±",
        senderUid: "system",
        type: "system",
        text: `${memberName} å·²è¢«ç§»å‡ºç¾¤çµ„`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
      };
      
      await db.collection("groupChats").doc(currentGroupId).collection("messages").add(removeMessage);
      
      // é‡æ–°è¼‰å…¥è¨­å®š
      const groupDoc = await db.collection("groups").doc(currentGroupId).get();
      if (groupDoc.exists) {
        currentGroupData = groupDoc.data();
        loadGroupSettings();
        // æ›´æ–°èŠå¤©é ­éƒ¨æˆå“¡æ•¸
        document.getElementById('chatHeaderSubtitle').textContent = `${currentGroupData.members.length} ä½æˆå“¡`;
      }
      
    } catch (error) {
      console.error("ç§»é™¤æˆå“¡å¤±æ•—:", error);
      alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  // é›¢é–‹ç¾¤çµ„
  async function leaveGroup() {
    const isOwner = uid === currentGroupData.owner;
    const confirmText = isOwner ? 
      "æ‚¨æ˜¯ç¾¤ä¸»ï¼Œé›¢é–‹å¾Œç¾¤çµ„å°‡è¢«è§£æ•£ã€‚ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ" : 
      "ç¢ºå®šè¦é›¢é–‹é€™å€‹ç¾¤çµ„å—ï¼Ÿ";
    
    if (!confirm(confirmText)) return;
    
    try {
      if (isOwner) {
        // ç¾¤ä¸»é›¢é–‹ = è§£æ•£ç¾¤çµ„
        await db.collection("groups").doc(currentGroupId).delete();
        
        // åˆªé™¤ç¾¤çµ„èŠå¤©è¨˜éŒ„
        const messagesRef = db.collection("groupChats").doc(currentGroupId).collection("messages");
        const batch = db.batch();
        const messagesSnapshot = await messagesRef.get();
        messagesSnapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        
        // åˆªé™¤ç¾¤çµ„èŠå¤©æ–‡æª”
        await db.collection("groupChats").doc(currentGroupId).delete();
        
      } else {
        // ä¸€èˆ¬æˆå“¡é›¢é–‹
        await db.collection("groups").doc(currentGroupId).update({
          members: firebase.firestore.FieldValue.arrayRemove(uid),
          admins: firebase.firestore.FieldValue.arrayRemove(uid),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ç™¼é€ç³»çµ±è¨Šæ¯
        const leaveMessage = {
          sender: "ç³»çµ±",
          senderUid: "system",
          type: "system",
          text: `${displayName} å·²é›¢é–‹ç¾¤çµ„`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
        };
        
        await db.collection("groupChats").doc(currentGroupId).collection("messages").add(leaveMessage);
      }
      
      // é—œé–‰è¨­å®š modal
      closeModal("groupSettingsModal");
      
      // æ¸…ç©ºèŠå¤©å€
      currentGroupId = null;
      currentGroupData = null;
      document.querySelector('.chat-header-title').textContent = "è«‹é¸æ“‡ç¾¤çµ„";
      document.getElementById('chatHeaderSubtitle').textContent = "";
      document.getElementById('chatHeaderActions').style.display = 'none';
      document.getElementById("messages").innerHTML = `
        <div class="empty-state">
          <h3>ğŸ’¬ é–‹å§‹ç¾¤çµ„èŠå¤©</h3>
          <p>é¸æ“‡ä¸€å€‹ç¾¤çµ„é–‹å§‹èŠå¤©ï¼Œæˆ–å»ºç«‹æ–°ç¾¤çµ„é‚€è«‹æœ‹å‹åŠ å…¥ï¼</p>
        </div>
      `;
      
      // åœç”¨è¼¸å…¥å€åŸŸ
      document.getElementById("messageInput").disabled = true;
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("fileBtn").disabled = true;
      
      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }
      
    } catch (error) {
      console.error("é›¢é–‹ç¾¤çµ„å¤±æ•—:", error);
      alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  // é¡¯ç¤ºç¾¤çµ„é¸é …é¸å–®
  function showGroupOptions(event, groupId) {
    event.stopPropagation();
    
    if (actionMenuEl) actionMenuEl.remove();
    
    actionMenuEl = document.createElement("div");
    actionMenuEl.classList.add("action-menu");
    actionMenuEl.style.top = Math.min(event.clientY, window.innerHeight - 100) + "px";
    actionMenuEl.style.left = Math.min(event.clientX, window.innerWidth - 120) + "px";
    
    const settingsOption = document.createElement("div");
    settingsOption.textContent = "ç¾¤çµ„è¨­å®š";
    settingsOption.onclick = async () => {
      // ç¢ºä¿ç•¶å‰ç¾¤çµ„è³‡æ–™æ˜¯æœ€æ–°çš„
      try {
        const groupDoc = await db.collection("groups").doc(groupId).get();
        if (groupDoc.exists) {
          currentGroupId = groupId;
          currentGroupData = groupDoc.data();
          loadGroupSettings();
          openModal("groupSettingsModal");
        }
      } catch (error) {
        console.error("è¼‰å…¥ç¾¤çµ„è³‡æ–™å¤±æ•—:", error);
        alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
      actionMenuEl.remove();
    };
    
    actionMenuEl.appendChild(settingsOption);
    document.body.appendChild(actionMenuEl);
  }

  // æ¸²æŸ“å¥½å‹åˆ—è¡¨
  function renderFriendList(friends, containerId) {
    const friendsList = document.getElementById(containerId);
    friendsList.innerHTML = "";
    
    if (!friends || friends.length === 0) {
      renderEmptyFriendList(containerId);
      return;
    }
    
    friends.forEach(friendUid => {
      db.collection("users").doc(friendUid).get().then(friendDoc => {
        if (friendDoc.exists) {
          const f = document.createElement("div");
          f.classList.add("friend");
          f.textContent = friendDoc.data().displayName;
          f.onclick = () => openChat(friendUid, f);
          friendsList.appendChild(f);
        }
      }).catch(() => {
        renderTestFriends(containerId);
      });
    });
  }

  function renderEmptyFriendList(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '<div style="padding: 15px; text-align: center; color: #888;">é‚„æ²’æœ‰å¥½å‹ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å¥½å‹å§ï¼</div>';
  }

  function renderTestFriends(containerId) {
    const friendsList = document.getElementById(containerId);
    friendsList.innerHTML = `
      <div class="friend" onclick="openTestChat('Alice', this)">Alice (æ¸¬è©¦ç”¨æˆ¶)</div>
      <div class="friend" onclick="openTestChat('Bob', this)">Bob (æ¸¬è©¦ç”¨æˆ¶)</div>
      <div class="friend" onclick="openTestChat('Charlie', this)">Charlie (æ¸¬è©¦ç”¨æˆ¶)</div>
    `;
  }

  // é–‹å•Ÿæ¸¬è©¦èŠå¤©ï¼ˆç”¨æ–¼æ¼”ç¤ºï¼‰
  function openTestChat(friendName, element) {
    document.querySelectorAll(".friend").forEach(f => f.classList.remove("active-friend"));
    element.classList.add("active-friend");
    
    currentFriendUid = friendName;
    currentGroupId = null;
    
    document.querySelector('.chat-header-title').textContent = `èˆ‡ ${friendName} çš„èŠå¤© (æ¸¬è©¦æ¨¡å¼)`;
    document.getElementById('chatHeaderSubtitle').textContent = "";
    document.getElementById('chatHeaderActions').style.display = 'none';
    
    document.getElementById("messageInput").disabled = false;
    document.getElementById("sendBtn").disabled = false;
    document.getElementById("fileBtn").disabled = false;
    
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = `
      <div class="message-wrapper">
        <div class="message other">
          <div><strong>${friendName}:</strong> å—¨ï¼é€™æ˜¯æ¸¬è©¦æ¶ˆæ¯ã€‚</div>
        </div>
      </div>
      <div class="message-wrapper">
        <div class="message self">
          <div><strong>${displayName}:</strong> ä½ å¥½ï¼å¾ˆé«˜èˆˆèªè­˜ä½ ã€‚</div>
        </div>
      </div>
    `;
  }

  // ä¸€èˆ¬å¥½å‹èŠå¤©åŠŸèƒ½ï¼ˆç§èŠï¼‰
  function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join("_");
  }

  function openChat(friendUid, element) {
    document.querySelectorAll(".friend").forEach(f => f.classList.remove("active-friend"));
    element.classList.add("active-friend");
    
    currentFriendUid = friendUid;
    currentGroupId = null;
    
    db.collection("users").doc(friendUid).get().then(friendDoc => {
      document.querySelector('.chat-header-title').textContent = `èˆ‡ ${friendDoc.data().displayName} çš„èŠå¤©`;
      document.getElementById('chatHeaderSubtitle').textContent = "";
      document.getElementById('chatHeaderActions').style.display = 'none';
      
      document.getElementById("messageInput").disabled = false;
      document.getElementById("sendBtn").disabled = false;
      document.getElementById("fileBtn").disabled = false;
    });

    if (unsubscribeMessages) unsubscribeMessages();
    const chatId = getChatId(uid, friendUid);
    unsubscribeMessages = db.collection("chats").doc(chatId)
      .collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        renderPrivateMessages(snapshot);
      });
  }

  function renderPrivateMessages(snapshot) {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";
    
    if (snapshot.empty) {
      messagesDiv.innerHTML = `
        <div class="empty-state">
          <h3>ğŸ‘‹ é–‹å§‹èŠå¤©å§ï¼</h3>
          <p>é€™æ˜¯ä½ å€‘çš„ç¬¬ä¸€æ¬¡å°è©±ï¼Œèªªé»ä»€éº¼å§ï¼</p>
        </div>
      `;
      return;
    }
    
    snapshot.forEach(doc => {
      const data = doc.data();
      const wrapper = document.createElement("div");
      wrapper.classList.add("message-wrapper");
      wrapper.id = `msg-${doc.id}`;
      
      const msgEl = document.createElement("div");
      msgEl.classList.add("message", data.sender === displayName ? "self" : "other");

      // å›è¦†å¼•ç”¨
      if (data.replyTo) {
        const replyRef = document.createElement("div");
        replyRef.classList.add("reply-reference");
        replyRef.textContent = "å›è¦†å…§å®¹ï¼šè¼‰å…¥ä¸­...";
        replyRef.onclick = () => scrollToMessage(data.replyTo);
        
        db.collection("chats").doc(getChatId(uid, currentFriendUid)).collection("messages").doc(data.replyTo)
          .get().then(rDoc => {
            if (rDoc.exists) {
              const replyData = rDoc.data();
              const previewText = getMessagePreview(replyData);
              replyRef.textContent = `å›è¦† ${replyData.sender}: ${previewText}`;
            }
          });
        msgEl.appendChild(replyRef);
      }

      // è¨Šæ¯å…§å®¹
      const contentDiv = document.createElement("div");
      if (data.type === "image") {
        const img = document.createElement("img");
        img.src = data.url;
        img.classList.add("chat-image");
        contentDiv.appendChild(img);
      } else if (data.type === "file") {
        const fileDiv = document.createElement("div");
        fileDiv.innerHTML = `ğŸ“ `;
        const a = document.createElement("a");
        a.href = data.url;
        a.textContent = data.fileName || "ä¸‹è¼‰æª”æ¡ˆ";
        a.target = "_blank";
        a.style.color = "blue";
        a.style.textDecoration = "underline";
        fileDiv.appendChild(a);
        contentDiv.appendChild(fileDiv);
      } else {
        const linkRegex = /(https:\/\/[^\s]+)/g;
        const safeText = data.text.replace(linkRegex, url => {
          return `<a href="${url}" target="_blank" style="color:blue;text-decoration:underline;">${url}</a>`;
        });
        contentDiv.innerHTML = `<strong>${data.sender}:</strong> ${safeText}`;
      }
      msgEl.appendChild(contentDiv);

// è‡ªå‹•æ¨™è¨˜å·²è®€
if (!data.readBy?.includes(uid) && data.senderUid !== uid) {
  // å»¶é²æ¨™è¨˜å·²è®€ï¼Œé¿å…ç«‹å³æ¨™è¨˜
  setTimeout(() => {
    try {
      if (currentGroupId) {
        db.collection("groupChats").doc(currentGroupId)
          .collection("messages").doc(doc.id)
          .update({
            readBy: firebase.firestore.FieldValue.arrayUnion(uid)
          });
      } else if (currentFriendUid) {
        const chatId = getChatId(uid, currentFriendUid);
        db.collection("chats").doc(chatId)
          .collection("messages").doc(doc.id)
          .update({
            readBy: firebase.firestore.FieldValue.arrayUnion(uid)
          });
      }
    } catch (error) {
      console.log("æ¨™è¨˜å·²è®€å¤±æ•—:", error);
    }
  }, 800);
}

// é¡¯ç¤ºç™¼é€æ™‚é–“èˆ‡å·²è®€äººæ•¸ï¼ˆå…©è¡Œæ ¼å¼ï¼‰
const metaDiv = document.createElement("div");
metaDiv.style.fontSize = "10px";
metaDiv.style.color = "#888";
metaDiv.style.marginTop = "2px";
metaDiv.style.whiteSpace = "pre-line"; // æ”¯æ´æ›è¡Œ
metaDiv.classList.add('meta-info');
// ç™¼é€æ™‚é–“æ ¼å¼åŒ–
let timeStr = "æ™‚é–“æœªçŸ¥";
if (data.timestamp?.toDate) {
  const dateObj = data.timestamp.toDate();
  const now = new Date();
  const isToday = dateObj.toDateString() === now.toDateString();
  
  let hours = dateObj.getHours();
  const minutes = String(dateObj.getMinutes()).padStart(2, "0");
  const period = hours >= 12 ? "ä¸‹åˆ" : "ä¸Šåˆ";
  if (hours > 12) hours -= 12;
  if (hours === 0) hours = 12;
  
  if (isToday) {
    timeStr = `${period}${hours}:${minutes}`;
  } else {
    const month = String(dateObj.getMonth() + 1).padStart(2, "0");
    const day = String(dateObj.getDate()).padStart(2, "0");
    timeStr = `${month}/${day} ${period}${hours}:${minutes}`;
  }
}

// å·²è®€äººæ•¸
const readCount = (data.readBy?.length || 0);
let statusText = "";

if (data.senderUid === uid) {
  // è‡ªå·±ç™¼é€çš„è¨Šæ¯
  if (readCount <= 1) {
    statusText = "âœ“ å·²ç™¼é€";
  } else {
    statusText = `âœ“âœ“ ${readCount} äººå·²è®€`;
  }
} else {
  // åˆ¥äººç™¼é€çš„è¨Šæ¯
  statusText = `${readCount} äººå·²è®€`;
}

metaDiv.textContent = `${timeStr} â€¢ ${statusText}`;
msgEl.appendChild(metaDiv);


      // ä¸‰é»é¸å–®æŒ‰éˆ•
      const moreBtn = document.createElement("button");
      moreBtn.textContent = "â‹¯";
      moreBtn.classList.add("more-btn");
      moreBtn.onclick = (e) => showPrivateActionMenu(e, doc.id, data);
      
      wrapper.appendChild(msgEl);
      wrapper.appendChild(moreBtn);
      messagesDiv.appendChild(wrapper);
    });
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function showPrivateActionMenu(e, messageId, messageData) {
    e.stopPropagation();
    if (actionMenuEl) actionMenuEl.remove();

    actionMenuEl = document.createElement("div");
    actionMenuEl.classList.add("action-menu");
    actionMenuEl.style.top = Math.min(e.clientY, window.innerHeight - 150) + "px";
    actionMenuEl.style.left = Math.min(e.clientX, window.innerWidth - 120) + "px";

    // å›è¦†åŠŸèƒ½
    const reply = document.createElement("div");
    reply.textContent = "å›è¦†è¨Šæ¯";
    reply.onclick = () => {
      replyToMessageId = messageId;
      document.getElementById("replyUser").textContent = messageData.sender;
      document.getElementById("replyText").textContent = getMessagePreview(messageData);
      document.getElementById("replyBox").style.display = "block";
      actionMenuEl.remove();
    };
    actionMenuEl.appendChild(reply);

    // å¦‚æœæ˜¯è‡ªå·±çš„è¨Šæ¯ï¼Œé¡¯ç¤ºæ”¶å›é¸é …
    if (messageData.sender === displayName) {
      const recall = document.createElement("div");
      recall.textContent = "æ”¶å›è¨Šæ¯";
      recall.style.color = "#e53e3e";
      recall.onclick = () => {
        messageToDelete = messageId;
        document.getElementById("confirmTitle").textContent = "ç¢ºèªæ”¶å›è¨Šæ¯";
        document.getElementById("confirmMessage").textContent = "ç¢ºå®šè¦æ”¶å›é€™å‰‡è¨Šæ¯å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚";
        document.getElementById("confirmModal").style.display = "flex";
        actionMenuEl.remove();
      };
      actionMenuEl.appendChild(recall);
    }

    document.body.appendChild(actionMenuEl);
  }

  // Modal æ§åˆ¶å‡½æ•¸
  function openModal(modalId) {
    document.getElementById(modalId).style.display = "flex";
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
  }

  // äº‹ä»¶ç›£è½å™¨è¨­ç½®
  function setupEventListeners() {
    // ç™¼é€è¨Šæ¯
    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("messageInput").addEventListener("keypress", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // æª”æ¡ˆä¸Šå‚³
    document.getElementById("fileBtn").onclick = () => {
      document.getElementById("fileInput").click();
    };
    document.getElementById("fileInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const type = file.type.startsWith("image/") ? "image" : "file";
      uploadFile(file, type);
      e.target.value = "";
    });

    // ç¾¤çµ„ç›¸é—œæŒ‰éˆ•
    document.getElementById("createGroupBtn").onclick = () => openModal("createGroupModal");
    document.getElementById("confirmCreateGroup").onclick = createGroup;
    document.getElementById("cancelCreateGroup").onclick = () => closeModal("createGroupModal");

    document.getElementById("inviteMembersBtn").onclick = () => {
      loadFriendSelectList();
      openModal("inviteMembersModal");
    };
    document.getElementById("confirmInviteMembers").onclick = inviteMembers;
    document.getElementById("cancelInviteMembers").onclick = () => closeModal("inviteMembersModal");

    document.getElementById("groupSettingsBtn").onclick = () => {
      loadGroupSettings();
      openModal("groupSettingsModal");
    };
    document.getElementById("saveGroupSettings").onclick = saveGroupSettings;
    document.getElementById("cancelGroupSettings").onclick = () => closeModal("groupSettingsModal");
    document.getElementById("leaveGroup").onclick = leaveGroup;

    // åŠ å¥½å‹
    document.getElementById("addFriendBtn").onclick = 
    document.getElementById("addFriendBtnMessages").onclick = () => openModal("addFriendModal");
    document.getElementById("confirmAddFriend").onclick = addFriend;
    document.getElementById("cancelAddFriend").onclick = () => closeModal("addFriendModal");

    // å›è¦†å–æ¶ˆ
    document.getElementById("replyCancel").onclick = () => {
      replyToMessageId = null;
      document.getElementById("replyBox").style.display = "none";
    };

    // ç¢ºèªå°è©±æ¡†
    document.getElementById("confirmYes").onclick = () => {
      if (messageToDelete) {
        deleteMessage(messageToDelete);
        messageToDelete = null;
      }
      closeModal("confirmModal");
    };
    document.getElementById("confirmNo").onclick = () => {
      messageToDelete = null;
      closeModal("confirmModal");
    };

    // é ­åƒé¸å–®
    document.getElementById("avatar-btn").onclick = (e) => {
      e.stopPropagation();
      const avatarMenu = document.getElementById('avatar-menu');
      avatarMenu.style.display = avatarMenu.style.display === 'block' ? 'none' : 'block';
    };

    document.getElementById("logout-btn").onclick = () => {
      if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
        localStorage.removeItem("userEmail");
        localStorage.removeItem("uid");
        window.location.href = "login.html";
      }
    };

    // é»æ“Šç©ºç™½è™•é—œé–‰é¸å–®å’Œæ¨¡æ…‹æ¡†
    document.addEventListener("click", (e) => {
      if (actionMenuEl && !actionMenuEl.contains(e.target)) {
        actionMenuEl.remove();
      }
      
      // é—œé–‰æ‰€æœ‰ modalï¼ˆé»æ“ŠèƒŒæ™¯æ™‚ï¼‰
      const modals = [
        "createGroupModal", "inviteMembersModal", "groupSettingsModal",
        "addFriendModal", "confirmModal"
      ];
      
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (e.target === modal) {
          closeModal(modalId);
        }
      });
      
      // é—œé–‰é ­åƒé¸å–®
      const avatarMenu = document.getElementById('avatar-menu');
      const avatarBtn = document.getElementById('avatar-btn');
      if (!avatarBtn.contains(e.target) && !avatarMenu.contains(e.target)) {
        avatarMenu.style.display = 'none';
      }
    });
  }

  // åŠ å¥½å‹åŠŸèƒ½
  async function addFriend() {
    const friendId = document.getElementById("friendIdInput").value.trim();
    const msgEl = document.getElementById("addFriendMsg");
    
    if (!friendId) {
      msgEl.textContent = "è«‹è¼¸å…¥å¥½å‹ID";
      return;
    }
    
    try {
      const friendQuery = await db.collection("users").where("friendId", "==", friendId).get();
      
      if (friendQuery.empty) {
        msgEl.textContent = "æ‰¾ä¸åˆ°æ­¤ç”¨æˆ¶";
        return;
      }
      
      const friendDoc = friendQuery.docs[0];
      const friendUid = friendDoc.id;
      
      if (friendUid === uid) {
        msgEl.textContent = "ä¸èƒ½åŠ è‡ªå·±ç‚ºå¥½å‹";
        return;
      }
      
      if (userFriends.includes(friendUid)) {
        msgEl.textContent = "å·²ç¶“æ˜¯å¥½å‹äº†";
        return;
      }
      
      // é›™å‘åŠ å¥½å‹
      await db.collection("users").doc(uid).update({
        friends: firebase.firestore.FieldValue.arrayUnion(friendUid)
      });
      
      await db.collection("users").doc(friendUid).update({
        friends: firebase.firestore.FieldValue.arrayUnion(uid)
      });
      
      closeModal("addFriendModal");
      document.getElementById("friendIdInput").value = "";
      msgEl.textContent = "";
      
    } catch (error) {
      console.error("åŠ å¥½å‹å¤±æ•—:", error);
      msgEl.textContent = "åŠ å¥½å‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
  }

  // åˆªé™¤è¨Šæ¯åŠŸèƒ½
  async function deleteMessage(messageId) {
    try {
      if (currentGroupId) {
        await db.collection("groupChats").doc(currentGroupId).collection("messages").doc(messageId).delete();
      } else if (currentFriendUid) {
        const chatId = getChatId(uid, currentFriendUid);
        await db.collection("chats").doc(chatId).collection("messages").doc(messageId).delete();
      }
    } catch (error) {
      console.error("åˆªé™¤è¨Šæ¯å¤±æ•—:", error);
      alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }

  // åˆå§‹åŒ–æ‡‰ç”¨
  async function initApp() {
    try {
      // ç¢ºä¿ç”¨æˆ¶è³‡æ–™å®Œæ•´
      await ensureFriendId();
      
      // è¨­ç½®äº‹ä»¶ç›£è½å™¨
      setupEventListeners();
      
      // é–‹å§‹ç›£è½è³‡æ–™
      listenFriendList();
      listenGroupList();
      
      console.log("æ‡‰ç”¨åˆå§‹åŒ–å®Œæˆ");
    } catch (error) {
      console.error("åˆå§‹åŒ–å¤±æ•—:", error);
      alert("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
    }
  }

  // ä¿®æ­£ Firebase Storage bucket
  firebase.app().options.storageBucket = "faycrchat.appspot.com";

  // å•Ÿå‹•æ‡‰ç”¨
  initApp();
</script>


<!-- START: Automatic fixes appended by assistant: improved sendMessage and openGroupChat with try/catch and safe wiring -->
<script>
// Override / improve sendMessage to handle group and private chat with proper awaits and error handling.
async function sendMessage() {
  const messageInput = document.getElementById("messageInput");
  if (!messageInput) return;
  const text = messageInput.value.trim();
  if (!text) return;

  if (!currentGroupId && !currentFriendUid) {
    // no target selected
    alert("è«‹å…ˆé¸æ“‡ç¾¤çµ„æˆ–å¥½å‹å†å‚³è¨Šæ¯");
    return;
  }

  const msgData = {
    sender: displayName || "æœªçŸ¥",
    senderUid: uid || "unknown_uid",
    type: "text",
    text: text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
  };
  if (replyToMessageId) {
    msgData.replyTo = replyToMessageId;
  }

  try {
    // disable input while sending to prevent double-send
    messageInput.disabled = true;
    document.getElementById("sendBtn").disabled = true;

    if (currentGroupId) {
      await db.collection("groupChats").doc(currentGroupId).collection("messages").add(msgData);

      // update group's lastMessage and updatedAt
      await db.collection("groups").doc(currentGroupId).update({
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessage: {
          sender: msgData.sender,
          text: msgData.text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
        }
      });
    } else {
      // private chat
      const chatId = getChatId(uid, currentFriendUid);
      await db.collection("chats").doc(chatId).collection("messages").add(msgData);
      // optionally update a chat index / meta doc if the app uses one
      try {
        await db.collection("chats").doc(chatId).set({
          lastMessage: {
            sender: msgData.sender,
            text: msgData.text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid] // è‡ªå·±å…ˆå·²è®€
          },
          participants: [uid, currentFriendUid]
        }, { merge: true });
      } catch (e) {
        // non-critical
        console.warn("æ›´æ–°ç§èŠç´¢å¼•å¤±æ•—", e);
      }
    }

    // success - clear input and reply state
    messageInput.value = "";
    replyToMessageId = null;
    const replyBox = document.getElementById("replyBox");
    if (replyBox) replyBox.style.display = "none";
  } catch (err) {
    console.error("ç™¼é€è¨Šæ¯å¤±æ•—:", err);
    // show inline error next to input if available, otherwise alert
    let errEl = document.getElementById("sendErrorInline");
    if (!errEl) {
      errEl = document.createElement("div");
      errEl.id = "sendErrorInline";
      errEl.style.color = "red";
      errEl.style.fontSize = "13px";
      errEl.style.marginTop = "6px";
      document.getElementById("input-area").appendChild(errEl);
    }
    errEl.textContent = "ç™¼é€å¤±æ•—ï¼š" + (err.message || err);
  } finally {
    // re-enable input even on error so user can retry
    if (messageInput) messageInput.disabled = false;
    const sendBtn = document.getElementById("sendBtn");
    if (sendBtn) sendBtn.disabled = false;
    // keep focus on input
    messageInput.focus();
  }
}

// Improved openGroupChat with try/catch and ensures currentGroupData is fresh.
window.openGroupChat = async function(groupId, groupData) {
  try {
    if (!groupId) throw new Error("groupId is required");
    // try to get latest group doc
    const groupDoc = await db.collection("groups").doc(groupId).get();
    if (!groupDoc || !groupDoc.exists) {
      // show friendly UI
      document.getElementById("messages").innerHTML = `
        <div class="empty-state">
          <h3>âŒ ç¾¤çµ„ä¸å­˜åœ¨</h3>
          <p>è©²ç¾¤çµ„å¯èƒ½å·²åˆªé™¤æˆ–æ‚¨å·²è¢«ç§»é™¤ã€‚</p>
        </div>`;
      // clear chat header and disable input
      currentGroupId = null;
      currentGroupData = null;
      document.querySelector('.chat-header-title').textContent = "è«‹é¸æ“‡ç¾¤çµ„";
      document.getElementById('chatHeaderSubtitle').textContent = "";
      document.getElementById('chatHeaderActions').style.display = 'none';
      document.getElementById("messageInput").disabled = true;
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("fileBtn").disabled = true;
      return;
    }

    currentGroupId = groupId;
    // prefer server data over passed-in data so settings are current
    currentGroupData = groupDoc.data();

    currentFriendUid = null;

    // Update UI selection
    document.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
    const selector = `[data-group-id="${groupId}"]`;
    const itemEl = document.querySelector(selector);
    if (itemEl) itemEl.classList.add('active');

    // Update header
    document.querySelector('.chat-header-title').textContent = currentGroupData.name || "ç¾¤çµ„";
    document.getElementById('chatHeaderSubtitle').textContent = `${currentGroupData.members ? currentGroupData.members.length : 0} ä½æˆå“¡`;
    document.getElementById('chatHeaderActions').style.display = 'flex';

    // enable input
    document.getElementById("messageInput").disabled = false;
    document.getElementById("sendBtn").disabled = false;
    document.getElementById("fileBtn").disabled = false;

    // attach group settings load for quick access
    // listen messages (unsubscribe previous)
    if (typeof unsubscribeMessages === 'function') {
      try { unsubscribeMessages(); } catch(e){}
      unsubscribeMessages = null;
    }

    unsubscribeMessages = db.collection("groupChats").doc(groupId)
      .collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        // use existing renderMessages function
        try { renderMessages(snapshot); } catch (e) {
          console.error("renderMessages error:", e);
        }
      }, (error) => {
        console.error("ç›£è½è¨Šæ¯å¤±æ•—:", error);
        document.getElementById("messages").innerHTML = `
          <div class="empty-state">
            <h3>âŒ è¼‰å…¥è¨Šæ¯å¤±æ•—</h3>
            <p>${error && error.message ? error.message : "ç›£è½é­é‡éŒ¯èª¤"}</p>
          </div>
        `;
      });
  } catch (error) {
    console.error("é–‹å•Ÿç¾¤çµ„å¤±æ•—:", error);
    alert("é–‹å•Ÿç¾¤çµ„å¤±æ•—ï¼š" + (error.message || error));
  }
};

// Wire up send button and Enter key (if not already)
(function wireSendControls(){
  const sendBtn = document.getElementById("sendBtn");
  if (sendBtn) sendBtn.removeEventListener('click', sendMessage).addEventListener('click', sendMessage);

  const input = document.getElementById("messageInput");
  if (input) {
    input.removeEventListener('keydown', window._assistantEnterHandler);
    window._assistantEnterHandler = function(e){
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    };
    input.addEventListener('keydown', window._assistantEnterHandler);
  }
})();

// Safe file input hookup: when file selected, upload as image or file based on mime
(function wireFileInput(){
  const fileInput = document.getElementById("fileInput");
  const fileBtn = document.getElementById("fileBtn");
  if (fileBtn && fileInput) {
    fileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      const f = files[0];
      // basic mime check
      const isImage = f.type && f.type.startsWith('image/');
      try {
        // disable while uploading
        fileBtn.disabled = true;
        await uploadFile(f, isImage ? 'image' : 'file');
      } catch (err) {
        console.error("uploadFile error:", err);
        alert("ä¸Šå‚³å¤±æ•—ï¼š" + (err.message || err));
      } finally {
        fileBtn.disabled = false;
        fileInput.value = "";
      }
    });
  }
})();
if (!location.hash) {
  location.hash = "#home";
}
// åœ¨ openGroupChat å‡½æ•°ä¸­ï¼Œæ›´æ–°å¤´éƒ¨æ—¶æ·»åŠ è¿”å›æŒ‰é’®
if (window.innerWidth <= 768) {
  const backBtn = document.createElement('button');
  backBtn.textContent = 'â† è¿”å›';
  backBtn.className = 'header-btn';
  backBtn.style.order = '-1';
  backBtn.onclick = () => {
    document.getElementById('middle-sidebar').classList.add('mobile-show');
    document.getElementById('chat-container').classList.add('mobile-hide');
  };
  
  const headerActions = document.getElementById('chatHeaderActions');
  headerActions.insertBefore(backBtn, headerActions.firstChild);
}
</script>
<!-- END: Automatic fixes appended by assistant -->

</body>
</html>